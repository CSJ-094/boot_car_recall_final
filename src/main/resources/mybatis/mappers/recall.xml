<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.RecallDAO">

    <insert id="insertRecall" parameterType="com.boot.dto.RecallDTO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO RECALL (
        MAKER, MODEL_NAME, MAKE_START, MAKE_END,
        RECALL_DATE, RECALL_REASON, VIN, REGISTRATION_NUMBER
        ) VALUES (
        #{maker}, #{modelName}, #{makeStart}, #{makeEnd},
        #{recallDate}, #{recallReason}, #{vin}, #{registrationNumber}
        )
    </insert>

    <insert id="insertRecallList" parameterType="java.util.List">
        INSERT INTO RECALL (MAKER, MODEL_NAME, MAKE_START, MAKE_END, RECALL_DATE, RECALL_REASON, VIN, REGISTRATION_NUMBER)
        VALUES
        <foreach collection="list" item="recall">
            (#{recall.maker}, #{recall.modelName}, #{recall.makeStart}, #{recall.makeEnd}, #{recall.recallDate}, #{recall.recallReason}, #{recall.vin}, #{recall.registrationNumber})
        </foreach>
    </insert>

    <resultMap id="recallResultMap" type="com.boot.dto.RecallDTO">
        <id property="id" column="ID"/>
        <result property="maker" column="MAKER" />
        <result property="modelName" column="MODEL_NAME" />
        <result property="makeStart" column="MAKE_START" />
        <result property="makeEnd" column="MAKE_END" />
        <result property="recallDate" column="RECALL_DATE" />
        <result property="recallReason" column="RECALL_REASON" />
        <result property="vin" column="VIN" />
        <result property="registrationNumber" column="REGISTRATION_NUMBER" />
    </resultMap>

    <select id="selectAllWithoutPagings" resultMap="recallResultMap">
        SELECT ID, MAKER, MODEL_NAME, MAKE_START, MAKE_END, RECALL_DATE, RECALL_REASON
        FROM RECALL
        ORDER BY ID DESC
    </select>

    <select id="selectAll" parameterType="com.boot.dto.Criteria" resultMap="recallResultMap">
        SELECT ID, MAKER, MODEL_NAME, MAKE_START, MAKE_END, RECALL_DATE, RECALL_REASON, VIN, REGISTRATION_NUMBER
        FROM RECALL
        <where>
            <if test="keyword != null and keyword != ''">
                UPPER(MAKER) LIKE CONCAT('%', UPPER(#{keyword}), '%')
                OR UPPER(MODEL_NAME) LIKE CONCAT('%', UPPER(#{keyword}), '%')
                OR UPPER(VIN) LIKE CONCAT('%', UPPER(#{keyword}), '%')
                OR UPPER(REGISTRATION_NUMBER) LIKE CONCAT('%', UPPER(#{keyword}), '%')
            </if>
        </where>
        ORDER BY ID DESC
        LIMIT #{amount} OFFSET ${(pageNum - 1) * amount}
    </select>

    <select id="count" parameterType="com.boot.dto.Criteria" resultType="int">
        SELECT COUNT(*) FROM RECALL
        <where>
            <if test="keyword != null and keyword != ''">
                UPPER(MAKER) LIKE CONCAT('%', UPPER(#{keyword}), '%')
                OR UPPER(MODEL_NAME) LIKE CONCAT('%', UPPER(#{keyword}), '%')
                OR UPPER(VIN) LIKE CONCAT('%', UPPER(#{keyword}), '%')
                OR UPPER(REGISTRATION_NUMBER) LIKE CONCAT('%', UPPER(#{keyword}), '%')
            </if>
        </where>
    </select>

    <select id="searchByModelName" parameterType="string" resultMap="recallResultMap">
        SELECT
        ID, MAKER, MODEL_NAME, MAKE_START, MAKE_END, RECALL_DATE, RECALL_REASON, VIN, REGISTRATION_NUMBER
        FROM RECALL
        WHERE UPPER(MODEL_NAME) LIKE CONCAT('%', UPPER(#{modelName}), '%')
        ORDER BY RECALL_DATE DESC
    </select>
    
    <select id="selectDistinctMaker" resultType="string">
    	SELECT DISTINCT MAKER
    	FROM RECALL
    	WHERE MAKER IS NOT NULL
      		AND TRIM(MAKER) != ''
    	ORDER BY MAKER
    </select>

    <select id="selectAllWithoutPaging" resultMap="recallResultMap">
        SELECT
        ID, MAKER, MODEL_NAME, MAKE_START, MAKE_END, RECALL_DATE, RECALL_REASON
        FROM RECALL
        ORDER BY ID DESC
    </select>

    <select id="selectById" parameterType="long" resultMap="recallResultMap">
        SELECT ID, MAKER, MODEL_NAME, MAKE_START, MAKE_END, RECALL_DATE, RECALL_REASON, VIN, REGISTRATION_NUMBER
        FROM RECALL
        WHERE ID = #{id}
    </select>

    <select id="searchByVin" parameterType="string" resultMap="recallResultMap">
        SELECT ID, MAKER, MODEL_NAME, MAKE_START, MAKE_END, RECALL_DATE, RECALL_REASON, VIN, REGISTRATION_NUMBER
        FROM RECALL
        WHERE UPPER(VIN) LIKE CONCAT('%', UPPER(#{vin}), '%')
        ORDER BY RECALL_DATE DESC
    </select>

    <select id="searchByRegistrationNumber" parameterType="string" resultMap="recallResultMap">
        SELECT ID, MAKER, MODEL_NAME, MAKE_START, MAKE_END, RECALL_DATE, RECALL_REASON, VIN, REGISTRATION_NUMBER
        FROM RECALL
        WHERE UPPER(REGISTRATION_NUMBER) LIKE CONCAT('%', UPPER(#{registrationNumber}), '%')
        ORDER BY RECALL_DATE DESC
    </select>

</mapper>
